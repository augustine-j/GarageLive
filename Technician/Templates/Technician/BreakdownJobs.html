{% extends 'Technician/Head_tech.html' %}
{% block content %}

<style>
  td.action-cell { white-space: nowrap; }
  .meta-muted { font-size: .85rem; color: #6c757d; }
</style>

<div class="main-panel">
  <div class="content-wrapper">

    <div class="row">
      <div class="col-lg-12 grid-margin stretch-card">
        <div class="card">
          <div class="card-body">

            <div class="d-flex justify-content-between mb-3">
              <div>
                <h4 class="card-title mb-1">Breakdown Assignments</h4>
                <p class="card-description mb-0">
                  Update breakdown progress based on service type
                </p>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Customer</th>
                    <th>Breakdown Service</th>
                    <th>Complaint</th>
                    <th>Vehicle</th>
                    <th>Status</th>
                    <th class="text-center">Action</th>
                  </tr>
                </thead>

                <tbody>
{% for i in data %}
<tr>
  <td>{{ forloop.counter }}</td>

  <!-- Customer -->
  <td>
    <strong>{{ i.booking.user.user_name }}</strong><br>
    <small class="text-muted">{{ i.booking.user.contact_number }}</small>
  </td>

  <!-- Breakdown Service -->
  <td>
    <span class="badge bg-warning text-dark">
      {{ i.servicecenter_breakdown_service.servicetype.servicetype_name }}
    </span>
  </td>

  <!-- Complaint -->
  <td>
    <span class="badge bg-warning text-dark">
    {{ i.booking.breakdown_complaint }}
    </span>
  </td>

  <!-- Vehicle -->
  <td>
    {{ i.booking.vehicle.model.brand.brand_name }}
    {{ i.booking.vehicle.model.model_name }}<br>
    <small class="text-muted">{{ i.booking.vehicle.vehicle_number }}</small>
  </td>

  <!-- Progress Text -->
  <td>
    {% if i.servicecenter_breakdown_service.servicetype.servicetype_name == "Fuel Refill" %}
      {% if i.progress_step == 0 %}Job Assigned
      {% elif i.progress_step == 1 %}On the way
      {% elif i.progress_step == 2 %}Arrived
      {% elif i.progress_step == 3 %}Fueled up

      {% else %}Completed{% endif %}

    {% elif i.servicecenter_breakdown_service.servicetype.servicetype_name == "Towing Service" %}
      {% if i.progress_step == 0 %}Job Assigned
      {% elif i.progress_step == 1 %}On the way
      {% elif i.progress_step == 2 %}Arrived
      {% elif i.progress_step == 3 %}Towing
      {% else %}Completed{% endif %}

    {% elif i.servicecenter_breakdown_service.servicetype.servicetype_name == "Tyre Puncture Repair" %}
      {% if i.progress_step == 0 %}Job Assigned
      {% elif i.progress_step == 1 %}On the way
      {% elif i.progress_step == 2 %}Arrived
      {% elif i.progress_step == 3 %}Tyre changed
      {% else %}Completed{% endif %}

    {% elif i.servicecenter_breakdown_service.servicetype.servicetype_name == "Battery Jump Start" %}
      {% if i.progress_step == 0 %}Job Assigned
      {% elif i.progress_step == 1 %}On the way
      {% elif i.progress_step == 2 %}Arrived

      {% elif i.progress_step == 3 %}Jump started
      {% else %}Completed{% endif %}
      

    {% else %}
      In progress
    {% endif %}
  </td>

  <td class="text-center">

  {# ---------- NEXT STEP BUTTON ---------- #}

  {% if i.servicecenter_breakdown_service.servicetype.servicetype_name == "Fuel Refill" %}
    {% if i.progress_step < 4 %}
      <a href="{% url 'Technician:update_breakdown_step' i.id %}"
         class="btn btn-sm btn-outline-primary">
        Next Step
      </a>
    {% else %}
      <span class="text-success fw-semibold">Done ✔</span>
    {% endif %}

  {% elif i.servicecenter_breakdown_service.servicetype.servicetype_name == "Battery Jump Start" %}
    {% if i.progress_step < 4 %}
      <a href="{% url 'Technician:update_breakdown_step' i.id %}"
         class="btn btn-sm btn-outline-primary">
        Next Step
      </a>
    {% else %}
      <span class="text-success fw-semibold">Done ✔</span>
    {% endif %}

  {% elif i.servicecenter_breakdown_service.servicetype.servicetype_name == "Tyre Puncture Repair" %}
    {% if i.progress_step < 4 %}
      <a href="{% url 'Technician:update_breakdown_step' i.id %}"
         class="btn btn-sm btn-outline-primary">
        Next Step
      </a>
    {% else %}
      <span class="text-success fw-semibold">Done ✔</span>
    {% endif %}

  {% elif i.servicecenter_breakdown_service.servicetype.servicetype_name == "Towing Service" %}
    {% if i.progress_step < 4 %}
      <a href="{% url 'Technician:update_breakdown_step' i.id %}"
         class="btn btn-sm btn-outline-primary">
        Next Step
      </a>
    {% else %}
      <span class="text-success fw-semibold">Done ✔</span>
    {% endif %}

  {% else %}
    <span class="text-muted">In progress</span>
  {% endif %}

  {# ---------- EXTRA CHARGE / BILLING LOCK ---------- #}

  {% if not i.billing_status %}

    {% if i.servicecenter_breakdown_service.servicetype.servicetype_name == "Fuel Refill" and i.progress_step >= 4 %}
      <a href="{% url 'Technician:update_breakdown_charge' i.id %}"
         class="btn btn-sm btn-outline-warning ms-1">
        Add Extra Charges
      </a>

    {% elif i.servicecenter_breakdown_service.servicetype.servicetype_name == "Battery Jump Start" and i.progress_step >= 4 %}
      <a href="{% url 'Technician:update_breakdown_charge' i.id %}"
         class="btn btn-sm btn-outline-warning ms-1">
        Add Extra Charges
      </a>

    {% elif i.servicecenter_breakdown_service.servicetype.servicetype_name == "Tyre Puncture Repair" and i.progress_step >= 4 %}
      <a href="{% url 'Technician:update_breakdown_charge' i.id %}"
         class="btn btn-sm btn-outline-warning ms-1">
        Add Extra Charges
      </a>

    {% elif i.servicecenter_breakdown_service.servicetype.servicetype_name == "Towing Service" and i.progress_step >= 4 %}
      <a href="{% url 'Technician:update_breakdown_charge' i.id %}"
         class="btn btn-sm btn-outline-warning ms-1">
        Add Extra Charges
      </a>
    {% endif %}

  {% else %}
    <span class="badge bg-success ms-1">
      Billing Locked
    </span>
  {% endif %}

</td>


</tr>
{% empty %}
<tr>
  <td colspan="6" class="text-center text-muted py-4">
    No breakdown jobs assigned.
  </td>
</tr>
{% endfor %}
</tbody>

              </table>
            </div>

          </div>
        </div>
      </div>
    </div>

  </div>
</div>

{% endblock content %}
