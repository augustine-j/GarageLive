{% extends 'ServiceCenter/Head_service.html' %}
{% block content %}


<style>
  .blink-dot {
    width: 9px;
    height: 9px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 6px;
    background-color: #dc3545;
    animation: blink 1.4s infinite;
  }
  @keyframes blink {
    0%,100% { opacity: 1; }
    50% { opacity: .3; }
  }
</style>

<div class="container-xxl py-4">
  <div class="row">
    <div class="col-lg-12 grid-margin stretch-card">
      <div class="card shadow-sm">
        <div class="card-body">

          <!-- Header -->
          <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
            <div>
              <h4 class="card-title mb-1">
                <span class="blink-dot"></span> Breakdown Requests
              </h4>
              <p class="card-description mb-0">
                Emergency roadside assistance requests.
              </p>
            </div>

            <div class="input-group" style="max-width:300px;">
              <span class="input-group-text">
                <i class="mdi mdi-magnify"></i>
              </span>
              <input id="bdSearch" type="text" class="form-control" placeholder="Search breakdowns...">
            </div>
          </div>

          <!-- Status Filter Pills -->

<div id="statusFilters" class="d-flex flex-wrap gap-2 mb-3">       
                    <button type="button" class="btn btn-sm btn-outline-warning active" data-status="all">
                      All <span class="badge bg-warning ms-1" id="cnt-all">0</span>
                    </button>

                  <button type="button" class="btn btn-sm btn-outline-danger" data-status="pending">
                    Pending <span class="badge bg-danger ms-1" id="cnt-pending">0</span>
                  </button>

                  <button type="button" class="btn btn-sm btn-outline-success" data-status="accepted">
                    Accepted <span class="badge bg-success ms-1" id="cnt-accepted">0</span>
                  </button>

                  <button type="button" class="btn btn-sm btn-outline-info" data-status="inprogress">
                    In Progress <span class="badge bg-info ms-1" id="cnt-inprogress">0</span>
                  </button>

                  <button type="button" class="btn btn-sm btn-outline-success" data-status="completed">
                    Completed <span class="badge bg-success ms-1" id="cnt-completed">0</span>
                  </button>

                  <button type="button" class="btn btn-sm btn-outline-dark" data-status="rejected">
                    Rejected <span class="badge bg-danger ms-1" id="cnt-rejected">0</span>
                  </button>
              </div>

          <form method="post">
            {% csrf_token %}

            <div class="table-responsive">
              <table class="table table-striped align-middle" id="bdTable">
                <thead>
                  <tr>
                    <th style="width:60px;">Sno</th>
                    <th>User</th>
                    <th>Contact</th>
                    <th>Date</th>
                    <th>Service Type</th>
                    <th>Complaint</th>
                    <th>Vehicle</th>
                    <th style="width:160px;">Vehicle Image</th>
                    <th style="width:160px;">Status</th>
                    <th style="width:220px;">Action</th>
                  </tr>
                </thead>

                <tbody>
                  {% for i in services %}
                 
                 <tr data-status="{% if i.booking.breakdown_status == 0 %}pending{% elif i.booking.breakdown_status == 2 %}rejected{% elif i.booking.breakdown_status == 5 or i.billing_status %}completed{% elif i.booking.breakdown_status == 1 and i.progress_step == 0 %}accepted{% elif i.booking.breakdown_status == 1 and i.progress_step > 0 %}inprogress{% else %}unknown{% endif %}">




                    <td class="fw-semibold">{{ forloop.counter }}</td>

                    <!-- User -->
                    <td>
                      <div class="d-flex flex-column">
                        <span class="fw-semibold">{{ i.booking.user.user_name }}</span>
                        <small class="text-muted">{{ i.booking.user.user_email }}</small>
                      </div>
                    </td>

                    <td>{{ i.booking.user.contact_number }}</td>

                    <td>
                      <span class="badge badge-outline-primary">
                        {{ i.booking.breakdown_date|date:"d M Y" }}
                      </span>
                    </td>

                    <td>
                    <span class="badge bg-warning text-dark">
                       {{ i.servicecenter_breakdown_service.servicetype.servicetype_name }}
                     </span>
                      </td>


                    <td style="max-width:260px;">
                      <div class="text-wrap">{{ i.booking.breakdown_complaint }}</div>
                    </td>

                    <!-- Vehicle -->
                    <td>
                      <div class="d-flex flex-column">
                        <span class="fw-semibold">
                          {{ i.booking.vehicle.model.brand.brand_name }}
                          {{ i.booking.vehicle.model.model_name }}
                        </span>
                        <small class="text-muted">{{ i.booking.vehicle.vehicle_number }}</small>
                      </div>
                    </td>

                    <!-- Vehicle Image -->
                    <td>
                      <img
                        src="{{ i.booking.vehicle.vehicle_photo.url }}"
                        alt="Vehicle"
                        class="img-fluid rounded shadow-sm"
                        style="width:150px; height:110px; object-fit:cover;"
                      />
                    </td>

                    <!-- Status -->
                    <td>
                    

                      {% if i.booking.breakdown_status == 0 %}
                        Pending Approval

                      {% elif i.booking.breakdown_status == 2 %}
                        Rejected

                      {% else %}
                        {# ========== ACCEPTED OR BEYOND ========== #}

                        {% if i.servicecenter_breakdown_service.servicetype.servicetype_name == "Fuel Refill" %}
                          {% if i.progress_step == 0 %}
                            Accepted
                          {% elif i.progress_step == 1 %}
                            On the Way
                          {% elif i.progress_step == 2 %}
                            Arrived
                          {% elif i.progress_step == 3 %}
                            Fueled up
                          {% else %}
                            Completed
                          {% endif %}

                        {% elif i.servicecenter_breakdown_service.servicetype.servicetype_name == "Battery Jump Start" %}
                          {% if i.progress_step == 0 %}
                            Accepted
                          {% elif i.progress_step == 1 %}
                            On the way
                          {% elif i.progress_step == 2 %}
                            Arrived
                          {% elif i.progress_step == 3 %}
                            Jump started
                            
                          {% else %}
                            Completed
                          {% endif %}

                        {% elif i.servicecenter_breakdown_service.servicetype.servicetype_name == "Tyre Puncture Repair" %}
                          {% if i.progress_step == 0 %}
                            Accepted
                          {% elif i.progress_step == 1 %}
                            On the way
                          {% elif i.progress_step == 2 %}
                            Arrived
                          {% elif i.progress_step == 3 %}
                            Tyre changed
                          {% else %}
                            Completed
                          {% endif %}

                        {% elif i.servicecenter_breakdown_service.servicetype.servicetype_name == "Towing Service" %}
                          {% if i.progress_step == 0 %}
                            Accepted
                          {% elif i.progress_step == 1 %}
                            On the way
                          {% elif i.progress_step == 2 %}
                            Vehicle reached
                          {% elif i.progress_step == 3 %}
                            Towing
                          {% else %}
                            Completed
                          {% endif %}

                        {% else %}
                          In progress
                        {% endif %}

                      {% endif %}

                </td>


                    <!-- Action -->
                   <td>
                              {% if i.booking.breakdown_status == 0 %}
                                <a class="btn btn-sm btn-success"
                                  href="{% url 'ServiceCenter:acceptbreakdown' i.booking.id %}">
                                  Accept
                                </a>
                                <a class="btn btn-sm btn-danger"
                                  href="{% url 'ServiceCenter:rejectbreakdown' i.booking.id %}">
                                  Reject
                                </a>

                              {% elif i.booking.breakdown_status == 1 %}
                                {% if not i.booking.technician %}
                                  <a class="btn btn-sm btn-primary"
                                    href="{% url 'ServiceCenter:breakdown_technician' i.booking.id %}">
                                    Assign Technician
                                  </a>
                                {% else %}
                                  <small class="text-muted">
                                    Technician:
                                    <b>{{ i.booking.technician.technician_name }}</b>
                                  </small>
                                {% endif %}

                              {% elif i.progress_step >= 1 and not i.billing_status %}
                                <span class="badge bg-warning text-dark">
                                  Awaiting Technician Billing
                                </span>

                              {% elif i.billing_status %}
                                <span class="badge bg-success">
                                  Billed
                                </span>

                              {% else %}
                                <span class="text-muted">No action</span>
                              {% endif %}
                            </td>


                  </tr>

                  {% empty %}
                  <tr>
                    <td colspan="9" class="text-center py-4 text-muted">
                      No breakdown requests found.
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </form>

        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  const searchInput = document.getElementById("bdSearch");
  const rows = Array.from(document.querySelectorAll("#bdTable tbody tr"));
  const buttons = document.querySelectorAll("#statusFilters button");

  let activeStatus = "all";

  const counters = {
    all: 0,
    pending: 0,
    accepted: 0,
    inprogress: 0,
    completed: 0,
    rejected: 0
  };

  // ðŸ”¹ INITIAL COUNT (RUNS ON PAGE LOAD)
  rows.forEach(row => {
    const st = row.dataset.status;
    counters.all++;
    if (counters[st] !== undefined) {
      counters[st]++;
    }
  });

  // ðŸ”¹ UPDATE BADGES
  Object.keys(counters).forEach(key => {
    const badge = document.getElementById(`cnt-${key}`);
    if (badge) {
      badge.innerText = counters[key];
    }
  });

  function applyFilters() {
    const q = searchInput.value.toLowerCase().trim();

    rows.forEach(row => {
      const matchesSearch = row.innerText.toLowerCase().includes(q);
      const matchesStatus =
        activeStatus === "all" ||
        row.dataset.status === activeStatus;

      row.style.display = (matchesSearch && matchesStatus) ? "" : "none";
    });
  }

  // ðŸ”¹ STATUS BUTTONS
  buttons.forEach(btn => {
    btn.addEventListener("click", function () {
      buttons.forEach(b => b.classList.remove("active"));
      this.classList.add("active");

      activeStatus = this.dataset.status;
      applyFilters();
    });
  });

  // ðŸ”¹ SEARCH
  searchInput.addEventListener("keyup", applyFilters);
})();
</script>



{% if msg %}
<script>
  alert("{{msg}}");
  window.location = "{% url 'ServiceCenter:breakdownrequest' %}";
</script>
{% endif %}





{% endblock content %}
