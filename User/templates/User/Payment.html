{% extends 'User/Head_User.html' %}
{% block content %}

<style>
:root{
  --rzp-blue:#0d6efd;
  --border:#e5e7eb;
  --bg:#f4f6f9;
  --text:#1f2937;
  --muted:#6b7280;
  --success:#16a34a;
}

/* PAGE */
.pay-page{
  min-height:100vh;
  background:var(--bg);
  display:flex;
  align-items:center;
  justify-content:center;
  padding:40px 20px;
}

.payment-container{
  width:100%;
  max-width:1100px;
  display:grid;
  grid-template-columns:1fr 420px;
  gap:30px;
}

/* LEFT BILL */
.bill-box{
  background:#fff;
  border:1px solid var(--border);
  border-radius:12px;
  padding:30px;
  box-shadow:0 10px 25px rgba(0,0,0,.05);
}

.bill-box h3{
  font-weight:600;
  margin-bottom:20px;
}

.label{
  font-size:12px;
  color:var(--muted);
  font-weight:600;
}

.service-card{
  border:1px solid var(--border);
  border-radius:8px;
  padding:15px;
  margin-bottom:15px;
}

.row-charge{
  display:flex;
  justify-content:space-between;
  font-size:14px;
  margin-bottom:6px;
  color:var(--muted);
}

.total{
  display:flex;
  justify-content:space-between;
  font-size:18px;
  font-weight:600;
  margin-top:15px;
}

.total span:last-child{
  color:var(--success);
}

.pay-btn{
  width:100%;
  height:48px;
  background:var(--rzp-blue);
  border:none;
  border-radius:8px;
  color:#fff;
  font-weight:600;
  margin-top:20px;
  cursor:pointer;
}

/* ===== Razorpay Modal ===== */
.rzp-modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

.rzp-box{
  width:100%;
  max-width:820px;
  background:#fff;
  border-radius:14px;
  overflow:hidden;
  box-shadow:0 25px 60px rgba(0,0,0,.25);
  display:flex;
  flex-direction:column;
}

.rzp-header{
  background:var(--rzp-blue);
  color:#fff;
  padding:16px 20px;
  font-weight:600;
  display:flex;
  justify-content:space-between;
}

.rzp-body{
  display:grid;
  grid-template-columns:340px 1fr;
}

/* 3D CARD */
.card-container{
  perspective:1200px;
  padding:30px;
  background:#f8fafc;
}

.credit-card{
  width:100%;
  height:210px;
  border-radius:16px;
  position:relative;
  transform-style:preserve-3d;
  transition:transform .8s cubic-bezier(.4,.2,.2,1);
}

.credit-card.flip{
  transform:rotateY(180deg);
}

.card-face{
  position:absolute;
  inset:0;
  border-radius:16px;
  padding:22px;
  backface-visibility:hidden;
  color:#fff;
}

.card-front{
  background:linear-gradient(135deg,#0d6efd,#2563eb);
  box-shadow:0 15px 35px rgba(13,110,253,.4);
}

.card-chip{
  width:42px;
  height:30px;
  background:linear-gradient(135deg,#d1d5db,#f3f4f6);
  border-radius:6px;
  margin-bottom:25px;
}

.card-number{
  font-size:18px;
  letter-spacing:2px;
  margin-bottom:25px;
}

.card-bottom{
  display:flex;
  justify-content:space-between;
  font-size:13px;
}

.card-back{
  background:#1e293b;
  transform:rotateY(180deg);
}

.card-stripe{
  height:45px;
  background:#000;
  margin-bottom:40px;
}

.card-cvv{
  background:#fff;
  color:#000;
  padding:6px 10px;
  border-radius:4px;
  text-align:right;
}

/* RIGHT SIDE */
.rzp-right{
  padding:30px;
}

.input-group{
  margin-bottom:15px;
}

.input-group input{
  width:100%;
  height:44px;
  border:1px solid var(--border);
  border-radius:8px;
  padding:0 12px;
}

.row{
  display:flex;
  gap:12px;
}

.pay-action{
  width:100%;
  height:46px;
  background:var(--rzp-blue);
  border:none;
  border-radius:8px;
  color:#fff;
  font-weight:600;
  margin-top:10px;
  cursor:pointer;
}

/* Processing */
.processing{
  text-align:center;
  padding:40px 20px;
  display:none;
}

.spinner{
  width:50px;
  height:50px;
  border:5px solid #e5e7eb;
  border-top:5px solid var(--rzp-blue);
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin:0 auto 20px;
}

@keyframes spin{to{transform:rotate(360deg)}}

/* Success */
.success-screen{
  text-align:center;
  padding:40px 20px;
  display:none;
}

.checkmark{
  width:80px;
  height:80px;
  border-radius:50%;
  background:var(--success);
  display:flex;
  align-items:center;
  justify-content:center;
  margin:0 auto 20px;
}

.checkmark svg{
  width:40px;
  height:40px;
  stroke:#fff;
  stroke-width:3;
  fill:none;
  stroke-dasharray:100;
  stroke-dashoffset:100;
  animation:draw 1s forwards .3s;
}

@keyframes draw{to{stroke-dashoffset:0}}

@media(max-width:900px){
  .payment-container{grid-template-columns:1fr;}
  .rzp-body{grid-template-columns:1fr;}
}
</style>

<div class="pay-page">
  <div class="payment-container">

    <!-- BILL SUMMARY -->
    <div class="bill-box">
      <h3>Booking Payment Details</h3>

      <div class="label">BOOKING ID</div>
      <div class="fw-bold">#{{ booking.id }}</div>

      <hr>

      {% for s in services %}
      <div class="service-card">
        <div class="d-flex justify-content-between">
          <strong>
            {{ s.servicecenter_services.servicetype.servicetype_name }}
          </strong>
          <strong class="text-success">
            ₹ {{ s.final_amount }}
          </strong>
        </div>

        <div class="row-charge">
          <span>Base Price</span>
          <span>₹ {{ s.base_amount }}</span>
        </div>
        <div class="row-charge">
          <span>Labour Charge</span>
          <span>₹ {{ s.labour_charge }}</span>
        </div>
        <div class="row-charge">
          <span>Parts Charge</span>
          <span>₹ {{ s.parts_charge }}</span>
        </div>
      </div>
      {% endfor %}

      <hr>

      <div class="total">
        <span>Total Payable</span>
        <span>₹ {{ total_amount }}</span>
      </div>

      <button class="pay-btn" onclick="openModal()">Pay Now</button>
    </div>

  </div>
</div>

<!-- Razorpay Modal -->
<div class="rzp-modal" id="rzpModal">
  <div class="rzp-box">

    <div class="rzp-header">
      <span>Razorpay Secure Payment</span>
      <span>₹ {{ total_amount }}</span>
    </div>

    <div class="rzp-body">

      <!-- 3D CARD -->
      <div class="card-container">
        <div class="credit-card" id="creditCard">
          <div class="card-face card-front">
            <div class="card-chip"></div>
            <div class="card-number" id="previewNumber">
              •••• •••• •••• ••••
            </div>
            <div class="card-bottom">
              <span id="previewName">CARD HOLDER</span>
              <span id="previewExpiry">MM/YY</span>
            </div>
          </div>
          <div class="card-face card-back">
            <div class="card-stripe"></div>
            <div class="card-cvv" id="previewCvv">000</div>
          </div>
        </div>
      </div>

      <!-- RIGHT SIDE -->
      <div class="rzp-right">

        <div id="paymentForm">
          <div class="input-group">
            <input type="text" id="cardNumber" placeholder="Card Number">
          </div>

          <div class="input-group">
            <input type="text" id="cardName" placeholder="Card Holder Name">
          </div>

          <div class="row">
            <div class="input-group" style="flex:1;">
              <input type="text" id="cardExpiry" placeholder="MM/YY">
            </div>
            <div class="input-group" style="flex:1;">
              <input type="text" id="cardCvv" placeholder="CVV">
            </div>
          </div>

          <button class="pay-action" onclick="startProcessing()">
            Pay ₹ {{ total_amount }}
          </button>
        </div>

        <div class="processing" id="processingScreen">
          <div class="spinner"></div>
          <p>Processing Payment...</p>
        </div>

        <div class="success-screen" id="successScreen">
          <div class="checkmark">
           
            <svg viewBox="0 0 52 52">
              <path d="M14 27 L22 35 L38 19"/>
            </svg>
            
          </div>
 <div class="alert alert-success mt-3">Payment Completed ✓</div>
          <form method="post">
            {% csrf_token %}
            <button type="submit" class="pay-action">
              Continue
            </button>
          </form>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
function openModal(){
  document.getElementById("rzpModal").style.display="flex";
}

function startProcessing(){
  document.getElementById("paymentForm").style.display="none";
  document.getElementById("processingScreen").style.display="block";

  setTimeout(function(){
    document.getElementById("processingScreen").style.display="none";
    document.getElementById("successScreen").style.display="block";
  },2000);
}

const card=document.getElementById("creditCard");

cardCvv.onfocus=()=> card.classList.add("flip");
cardCvv.onblur=()=> card.classList.remove("flip");

cardNumber.oninput=()=>{
  let val=cardNumber.value.replace(/\s/g,'').replace(/(\d{4})/g,'$1 ').trim();
  previewNumber.innerText=val||"•••• •••• •••• ••••";
};

cardName.oninput=()=>{
  previewName.innerText=cardName.value||"CARD HOLDER";
};

cardExpiry.oninput=()=>{
  previewExpiry.innerText=cardExpiry.value||"MM/YY";
};

cardCvv.oninput=()=>{
  previewCvv.innerText=cardCvv.value||"000";
};
</script>

{% endblock content %}
